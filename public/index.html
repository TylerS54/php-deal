<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Monopoly Deal</title>

    <!-- Load Firebase (with useEmulator=true for local) -->
    <script defer src="/__/firebase/11.1.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/11.1.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/11.1.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/11.1.0/firebase-functions-compat.js"></script>
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Let user input name
        const nameInput = document.getElementById('playerName');

        // Firestore handle
        const db = firebase.firestore();

        // Track the current game + unsubscribe
        let currentGameId = null;
        let unsubscribeGame = null;

        // Utility to watch a given game
        function watchGame(gameId) {
          currentGameId = gameId;
          if (unsubscribeGame) {
            unsubscribeGame();
          }
          const gameRef = db.collection('games').doc(gameId);
          unsubscribeGame = gameRef.onSnapshot((doc) => {
            if (!doc.exists) {
              document.getElementById('gameState').innerText = 'Game does not exist.';
              return;
            }
            document.getElementById('gameState').innerText = JSON.stringify(
              doc.data(),
              null,
              2
            );
          });
        }

        // CREATE GAME
        document.getElementById('btnCreateGame').addEventListener('click', async () => {
          const playerName = nameInput.value.trim();
          if (!playerName) {
            alert('Please enter your name first!');
            return;
          }
          try {
            const createGameFn = firebase.functions().httpsCallable('createGame');
            const result = await createGameFn({
              hostUid: playerName,
              playerIds: [playerName],
            });
            const gameId = result.data.gameId;
            alert('Created new game with ID: ' + gameId);
            watchGame(gameId);
          } catch (err) {
            console.error('Create game error:', err);
            alert(err.message);
          }
        });

        // JOIN GAME
        document.getElementById('btnJoinGame').addEventListener('click', async () => {
          const playerName = nameInput.value.trim();
          if (!playerName) {
            alert('Please enter your name first!');
            return;
          }
          const gameId = prompt('Enter game ID:');
          if (!gameId) return;

          const gameRef = db.collection('games').doc(gameId);
          try {
            // Add user’s name to the game’s playerIds array
            await db.runTransaction(async (transaction) => {
              const docSnap = await transaction.get(gameRef);
              if (!docSnap.exists) {
                throw new Error('Game does not exist!');
              }
              transaction.update(gameRef, {
                playerIds: firebase.firestore.FieldValue.arrayUnion(playerName),
              });
            });
            alert(`Joined game ${gameId} as ${playerName}`);
            watchGame(gameId);
          } catch (err) {
            console.error(err);
            alert(err.message);
          }
        });

        // PLAY PROPERTY
        document.getElementById('btnPlayProperty').addEventListener('click', async () => {
          if (!currentGameId) {
            alert('No game joined yet.');
            return;
          }
          const playMoveFn = firebase.functions().httpsCallable('playMove');
          // Hard-coded example
          const playerName = nameInput.value.trim() || 'playerA'; // fallback
          const move = {
            actionType: 'PLAY_PROPERTY',
            card: { id: 'p-red-1', type: 'property', color: 'red' },
            color: 'red',
            playerId: playerName,
          };
          try {
            const result = await playMoveFn({ gameId: currentGameId, move });
            console.log('Move result:', result.data);
          } catch (err) {
            alert('Error playing property: ' + err.message);
          }
        });
      });
    </script>
  </head>
  <body style="font-family:sans-serif;">
    <h1>Monopoly Deal</h1>

    <!-- Single input for the user’s name -->
    <div>
      <label for="playerName">Your Name: </label>
      <input id="playerName" type="text" placeholder="e.g. Alice" />
    </div>

  <!-- Buttons, etc. -->
  <div>
    <button id="btnCreateGame">Create Game</button>
    <button id="btnJoinGame">Join Game</button>
    <button id="btnPlayProperty">Play Property</button>
  </div>

  <pre id="gameState" style="background:#eee; padding:1em; white-space: pre-wrap;"></pre>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // 1. Sign in anonymously, so request.auth is not null
      //    (Alternatively, use a real auth provider like Google).
      try {
        await firebase.auth().signInAnonymously();
        console.log('Signed in anonymously!');
      } catch (error) {
        console.error('Error signing in anonymously:', error);
      }

      // 2. Now you can safely do Firestore reads and writes
      const db = firebase.firestore();

      // Example: create a game
      document.getElementById('btnCreateGame').addEventListener('click', async () => {
        const createGameFn = firebase.functions().httpsCallable('createGame');
        try {
          const result = await createGameFn({ hostUid: 'PLAYER_A', playerIds: ['PLAYER_A', 'PLAYER_B'] });
          console.log('Created game:', result.data.gameId);
          watchGame(result.data.gameId);
        } catch (err) {
          console.error('Error creating game:', err);
          alert(err.message);
        }
      });

      // Example: join a game
      document.getElementById('btnJoinGame').addEventListener('click', () => {
        const gameId = prompt('Enter gameId:');
        if (gameId) watchGame(gameId);
      });

      // Example: play a property
      document.getElementById('btnPlayProperty').addEventListener('click', async () => {
        if (!currentGameId) {
          alert('No game joined yet!');
          return;
        }
        const playMoveFn = firebase.functions().httpsCallable('playMove');
        try {
          const move = {
            actionType: 'PLAY_PROPERTY',
            card: { id: 'p-red-1', type: 'property', color: 'red' },
            color: 'red',
            playerId: 'PLAYER_A',
          };
          const result = await playMoveFn({ gameId: currentGameId, move });
          console.log('Played property:', result.data);
        } catch (err) {
          alert('Error playing property: ' + err.message);
        }
      });

      // Realtime game watching
      let currentGameId = null;
      let unsubscribeGame = null;
      function watchGame(gameId) {
        currentGameId = gameId;
        if (unsubscribeGame) unsubscribeGame();
        const gameRef = db.collection('games').doc(gameId);
        unsubscribeGame = gameRef.onSnapshot((doc) => {
          if (!doc.exists) {
            document.getElementById('gameState').innerText = 'Game does not exist.';
            return;
          }
          document.getElementById('gameState').innerText = JSON.stringify(doc.data(), null, 2);
        });
      }
    });
  </script>
</body>
</html>