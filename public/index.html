<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Monopoly Deal</title>

    <!-- Firebase scripts (with useEmulator for local testing) -->
    <script defer src="/__/firebase/11.1.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/11.1.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/11.1.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/11.1.0/firebase-functions-compat.js"></script>

    <!-- This loads your Firebase config for local dev (auth+firestore emulators, etc.) -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>

    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        background: #fafafa;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 16px;
      }
      .players-container {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-top: 16px;
      }
      .player-card {
        width: 200px;
        background: #fff;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: relative;
      }
      .player-card-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }
      .player-turn {
        position: absolute;
        top: 0; right: 0;
        background: #ef5350;
        color: white;
        font-size: 12px;
        padding: 2px 6px;
        border-bottom-left-radius: 8px;
        border-top-right-radius: 8px;
      }
      .card {
        display: inline-block;
        margin: 4px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: transform 0.2s; /* smooth enlarge */
      }
      .card img {
        width: 60px;
        border-radius: 4px;
        transition: transform 0.2s;
      }
      /* Hover to enlarge */
      .card:hover img {
        transform: scale(1.5);
        z-index: 99;
      }

      /* Bank styling example */
      .player-bank {
        margin-top: 8px;
      }
      .bank-total {
        font-weight: bold;
      }
      .debug-output {
        background:#eee; 
        padding:1em; 
        white-space:pre-wrap; 
        margin-top:16px;
        max-height: 300px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Monopoly Deal</h1>

      <!-- Name input -->
      <div>
        <label for="playerName">Your Name: </label>
        <input id="playerName" type="text" placeholder="e.g. Alice" />
      </div>

      <!-- Buttons -->
      <div style="margin-top: 16px;">
        <button id="btnCreateGame">Create Game</button>
        <button id="btnJoinGame">Join Game</button>
        <button id="btnStartGame" style="display:none;">Start Game</button>
        <button id="btnBeginTurn" style="display:none;">Begin Turn</button>
        <button id="btnEndTurn" style="display:none;">End Turn</button>
      </div>

      <!-- Show the current game code, e.g. "Game Code: ABC12" -->
      <div id="gameCode" style="font-size:20px; margin:16px 0;"></div>

      <!-- Show game status -->
      <div id="gameStatusBanner" style="font-size:18px; font-weight:bold;"></div>

      <!-- A place to show players, their cards, etc. -->
      <div class="players-container" id="playersContainer"></div>

      <!-- Debug JSON -->
      <pre class="debug-output" id="gameState"></pre>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          await firebase.auth().signInAnonymously();
          console.log('Signed in anonymously');
        } catch (error) {
          console.error('Error signing in anonymously:', error);
        }

        const db = firebase.firestore();
        const functions = firebase.functions();

        let currentGameId = null;
        let unsubscribeGame = null;

        // Watch a given game ID in Firestore
        function watchGame(gameId) {
          currentGameId = gameId;
          if (unsubscribeGame) unsubscribeGame();
          const gameRef = db.collection('games').doc(gameId);
          unsubscribeGame = gameRef.onSnapshot((doc) => {
            if (!doc.exists) {
              document.getElementById('gameState').innerText = 'Game does not exist.';
              return;
            }
            const data = doc.data();
            renderGame(gameId, data);
          });
        }

        // Renders the entire game state for the UI
        function renderGame(gameId, gameData) {
          document.getElementById('gameState').innerText = JSON.stringify(gameData, null, 2);
          document.getElementById('gameCode').textContent = 'Game Code: ' + gameId;

          const { status, hostUid, playerIds, turnIndex, hands, properties, bank, numPlaysThisTurn } = gameData;
          document.getElementById('gameStatusBanner').textContent = 'Game Status: ' + status;

          // If I'm the host & status=lobby, show startGame
          const localName = document.getElementById('playerName').value.trim();
          const btnStartGame = document.getElementById('btnStartGame');
          btnStartGame.style.display = (localName === hostUid && status === 'lobby') ? 'inline-block' : 'none';

          // If status=inProgress and it's my turn, show Begin/End Turn if needed.
          const btnBeginTurn = document.getElementById('btnBeginTurn');
          const btnEndTurn = document.getElementById('btnEndTurn');

          if (status === 'inProgress' && localName === playerIds[turnIndex]) {
            btnBeginTurn.style.display = (numPlaysThisTurn === 0) ? 'inline-block' : 'none';
            btnEndTurn.style.display = 'inline-block';
          } else {
            btnBeginTurn.style.display = 'none';
            btnEndTurn.style.display = 'none';
          }

          // Render each player's section
          const container = document.getElementById('playersContainer');
          container.innerHTML = '';

          if (!playerIds) return;
          playerIds.forEach((pName, idx) => {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'player-card';

            // Turn marker
            if (status === 'inProgress' && idx === turnIndex) {
              const turnBadge = document.createElement('div');
              turnBadge.className = 'player-turn';
              turnBadge.textContent = 'TURN';
              cardDiv.appendChild(turnBadge);
            }

            // Header: avatar + name
            const header = document.createElement('div');
            header.className = 'player-card-header';
            cardDiv.appendChild(header);

            const avatarUrl = `https://api.dicebear.com/6.x/bottts/svg?seed=${encodeURIComponent(pName)}`;
            const img = document.createElement('img');
            img.src = avatarUrl;
            img.width = 40; 
            img.height = 40;
            header.appendChild(img);

            const nameSpan = document.createElement('span');
            nameSpan.textContent = pName;
            header.appendChild(nameSpan);

            // Show player's bank
            const bankDiv = document.createElement('div');
            bankDiv.className = 'player-bank';
            const playerBank = (bank && bank[pName]) || [];
            let totalBankValue = 0;
            playerBank.forEach((bCard) => {
              totalBankValue += bCard.value || 0;
            });
            bankDiv.innerHTML = `<strong>Bank ($${totalBankValue}):</strong><br/>`;
            // Show each banked card image
            playerBank.forEach((bCard) => {
              const c = document.createElement('div');
              c.className = 'card';
              if (bCard.imageUrl) {
                const bImg = document.createElement('img');
                bImg.src = bCard.imageUrl;
                c.appendChild(bImg);
              } else {
                c.textContent = bCard.title || bCard.id;
              }
              bankDiv.appendChild(c);
            });
            cardDiv.appendChild(bankDiv);

            // Show player's properties
            const propDiv = document.createElement('div');
            propDiv.innerHTML = '<strong>Properties:</strong><br/>';
            const playerProps = (properties && properties[pName]) || {};
            Object.keys(playerProps).forEach((color) => {
              const colorCards = playerProps[color] || [];
              colorCards.forEach((pcard) => {
                const c = document.createElement('div');
                c.className = 'card';
                if (pcard.imageUrl) {
                  const pImg = document.createElement('img');
                  pImg.src = pcard.imageUrl;
                  c.appendChild(pImg);
                } else {
                  c.textContent = pcard.title || pcard.id;
                }
                propDiv.appendChild(c);
              });
            });
            cardDiv.appendChild(propDiv);

            // Show hand (only if local player)
            const handDiv = document.createElement('div');
            if (pName === localName) {
              handDiv.innerHTML = '<strong>Your Hand:</strong><br/>';
              const myHand = (hands && hands[pName]) || [];
              myHand.forEach((hCard) => {
                const c = document.createElement('div');
                c.className = 'card';
                if (hCard.imageUrl) {
                  const hImg = document.createElement('img');
                  hImg.src = hCard.imageUrl;
                  c.appendChild(hImg);
                } else {
                  c.textContent = hCard.title || hCard.id;
                }

                // On click => ask user how to play/bank
                c.addEventListener('click', async () => {
                  // If it's property, only "play property." If it's non-property, we can ask bank or action
                  if (hCard.type === 'property' || hCard.type === 'property-wild') {
                    if (!confirm(`Play ${hCard.title || hCard.id} as property?`)) return;
                    try {
                      const playMoveFn = functions.httpsCallable('playMove');
                      const result = await playMoveFn({
                        gameId: currentGameId,
                        move: {
                          actionType: 'PLAY_CARD',
                          playerId: localName,
                          card: hCard,
                          playAs: 'property',
                          color: hCard.color || 'any',
                        },
                      });
                      console.log('PLAY_CARD result:', result.data);
                    } catch (err) {
                      alert(err.message);
                    }
                  } else {
                    // Not a property => can be banked or used as an action
                    const choice = prompt(`Type 'bank' or 'action' to use ${hCard.title || hCard.id}`);
                    if (!choice) return;
                    if (choice === 'bank' || choice === 'action') {
                      try {
                        const playMoveFn = functions.httpsCallable('playMove');
                        const result = await playMoveFn({
                          gameId: currentGameId,
                          move: {
                            actionType: 'PLAY_CARD',
                            playerId: localName,
                            card: hCard,
                            playAs: choice,
                          },
                        });
                        console.log('PLAY_CARD result:', result.data);
                      } catch (err) {
                        alert(err.message);
                      }
                    }
                  }
                });

                handDiv.appendChild(c);
              });
            } else {
              const count = (hands && hands[pName]) ? hands[pName].length : 0;
              handDiv.innerHTML = `<strong>Cards in Hand:</strong> ${count}`;
            }
            cardDiv.appendChild(handDiv);

            container.appendChild(cardDiv);
          });
        }

        // Create Game
        document.getElementById('btnCreateGame').addEventListener('click', async () => {
          const playerName = document.getElementById('playerName').value.trim();
          if (!playerName) {
            alert('Please enter your name first!');
            return;
          }
          try {
            const fn = functions.httpsCallable('createGame');
            const result = await fn({
              hostUid: playerName,
              playerIds: [playerName],
            });
            const gameId = result.data.gameId;
            alert('Created new game with ID: ' + gameId);
            watchGame(gameId);
          } catch (err) {
            alert(err.message);
          }
        });

        // Join Game
        document.getElementById('btnJoinGame').addEventListener('click', async () => {
          const playerName = document.getElementById('playerName').value.trim();
          if (!playerName) {
            alert('Please enter your name first!');
            return;
          }
          const gameId = prompt('Enter game ID:');
          if (!gameId) return;

          try {
            const gameRef = db.collection('games').doc(gameId);
            await db.runTransaction(async (tx) => {
              const snap = await tx.get(gameRef);
              if (!snap.exists) throw new Error('Game does not exist!');
              const data = snap.data();
              if (data.status !== 'lobby') {
                throw new Error('Game already in progress or finished!');
              }
              tx.update(gameRef, {
                playerIds: firebase.firestore.FieldValue.arrayUnion(playerName),
                [`hands.${playerName}`]: [],
                [`bank.${playerName}`]: [],
                [`properties.${playerName}`]: {},
              });
            });
            alert(`Joined game ${gameId} as ${playerName}`);
            watchGame(gameId);
          } catch (err) {
            alert(err.message);
          }
        });

        // Start Game
        document.getElementById('btnStartGame').addEventListener('click', async () => {
          if (!currentGameId) {
            alert('No game code available.');
            return;
          }
          try {
            const fn = functions.httpsCallable('startGame');
            await fn({ gameId: currentGameId });
            alert('Game started! (5 cards dealt to each player)');
          } catch (err) {
            alert(err.message);
          }
        });

        // Begin Turn (draw 2)
        document.getElementById('btnBeginTurn').addEventListener('click', async () => {
          if (!currentGameId) return;
          const localName = document.getElementById('playerName').value.trim();
          const fn = functions.httpsCallable('playMove');
          try {
            await fn({ 
              gameId: currentGameId,
              move: {
                actionType: 'BEGIN_TURN',
                playerId: localName,
              },
            });
            console.log('Drew 2 cards');
          } catch (err) {
            alert(err.message);
          }
        });

        // End Turn
        document.getElementById('btnEndTurn').addEventListener('click', async () => {
          if (!currentGameId) return;
          const localName = document.getElementById('playerName').value.trim();
          const fn = functions.httpsCallable('playMove');
          try {
            await fn({
              gameId: currentGameId,
              move: {
                actionType: 'END_TURN',
                playerId: localName,
              },
            });
            console.log('Turn ended, forced discard if >7, next turn now');
          } catch (err) {
            alert(err.message);
          }
        });

      });
    </script>
  </body>
</html>
