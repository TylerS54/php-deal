<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Monopoly Deal</title>

    <!-- Firebase scripts (with useEmulator for local testing) -->
    <script defer src="/__/firebase/11.1.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/11.1.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/11.1.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/11.1.0/firebase-functions-compat.js"></script>

    <!-- This loads your Firebase config for local dev (auth+firestore emulators, etc.) -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>

    <style>
      /* Basic layout styles */
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        background: #fafafa;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 16px;
      }

      /* Player cards grid */
      .players-container {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-top: 16px;
      }
      .player-card {
        width: 180px;
        background: #fff;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: relative;
      }
      .player-card-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }
      .player-card img {
        border-radius: 5%;
      }
      .player-card .player-name {
        font-weight: bold;
      }
      .player-card .player-turn {
        position: absolute;
        top: 0; right: 0;
        background: #ef5350;
        color: white;
        font-size: 12px;
        padding: 2px 6px;
        border-bottom-left-radius: 8px;
        border-top-right-radius: 8px;
      }
      .player-card .player-status {
        font-size: 14px;
        color: #555;
      }
      .player-hand,
      .player-properties {
        margin-top: 8px;
      }

      /* Cards displayed as inline-block for example */
      .card {
        display: inline-block;
        background: #e0e0e0;
        border-radius: 4px;
        padding: 4px 8px;
        margin: 4px;
      }

      .status-banner {
        margin-top: 16px;
        font-size: 18px;
        font-weight: bold;
      }

      .game-code {
        font-size: 20px;
        margin: 16px 0;
      }

      /* Example styling for the debug JSON */
      pre.debug-output {
        background:#eee; 
        padding:1em; 
        white-space:pre-wrap; 
        margin-top:16px;
        max-height: 300px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Monopoly Deal</h1>

      <!-- Name input -->
      <div>
        <label for="playerName">Your Name: </label>
        <input id="playerName" type="text" placeholder="e.g. Alice" />
      </div>

      <!-- Buttons -->
      <div style="margin-top: 16px;">
        <button id="btnCreateGame">Create Game</button>
        <button id="btnJoinGame">Join Game</button>
        <button id="btnPlayProperty">Play Property</button>
        <!-- The host will see this start button if status === 'lobby' -->
        <button id="btnStartGame" style="display:none;">Start Game</button>
      </div>

      <!-- Show the current game code, e.g. "Game Code: ABC12" -->
      <div class="game-code" id="gameCode"></div>

      <!-- Show game status, e.g. "In Lobby" or "In Progress" -->
      <div class="status-banner" id="gameStatusBanner"></div>

      <!-- A place to show players, their cards, etc. -->
      <div class="players-container" id="playersContainer"></div>

      <!-- The raw JSON data (optional for debugging) -->
      <pre class="debug-output" id="gameState"></pre>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        // 1) Sign in anonymously
        try {
          await firebase.auth().signInAnonymously();
          console.log('Signed in anonymously');
        } catch (error) {
          console.error('Error signing in anonymously:', error);
        }

        const db = firebase.firestore();
        const functions = firebase.functions();
        let currentGameId = null;
        let unsubscribeGame = null;

        // 2) watchGame helper
        function watchGame(gameId) {
          currentGameId = gameId;
          if (unsubscribeGame) {
            unsubscribeGame();
          }
          const gameRef = db.collection('games').doc(gameId);
          unsubscribeGame = gameRef.onSnapshot((doc) => {
            if (!doc.exists) {
              document.getElementById('gameState').innerText = 'Game does not exist.';
              document.getElementById('gameCode').textContent = '';
              document.getElementById('gameStatusBanner').textContent = '';
              document.getElementById('playersContainer').innerHTML = '';
              return;
            }
            const data = doc.data();
            renderGame(gameId, data);
          });
        }

        // 3) Render the game in the UI
        function renderGame(gameId, gameData) {
          // Show raw JSON for debugging
          document.getElementById('gameState').innerText = JSON.stringify(gameData, null, 2);

          // Show the game code
          document.getElementById('gameCode').textContent = 'Game Code: ' + gameId;

          // Show game status
          const { status, hostUid, playerIds, turnIndex, hands, properties } = gameData;
          document.getElementById('gameStatusBanner').textContent = 'Game Status: ' + (status || '???');

          // If you are the host and status === 'lobby', show the "Start Game" button
          const localName = document.getElementById('playerName').value.trim();
          const startBtn = document.getElementById('btnStartGame');
          if (localName === hostUid && status === 'lobby') {
            startBtn.style.display = 'inline-block';
          } else {
            startBtn.style.display = 'none';
          }

          // Render the players
          const playersContainer = document.getElementById('playersContainer');
          playersContainer.innerHTML = ''; // clear old stuff

          // We'll interpret "hands" as an object: { [playerName]: Card[] }
          // and "properties" as { [playerName]: { [colorName]: Card[] } }
          if (!playerIds) return;

          playerIds.forEach((playerName, index) => {
            // Build a card for each player
            const playerDiv = document.createElement('div');
            playerDiv.className = 'player-card';

            // If it’s that player’s turn
            if (index === turnIndex && status === 'inProgress') {
              const turnBadge = document.createElement('div');
              turnBadge.className = 'player-turn';
              turnBadge.textContent = 'TURN';
              playerDiv.appendChild(turnBadge);
            }

            // Header: avatar + name
            const headerDiv = document.createElement('div');
            headerDiv.className = 'player-card-header';
            playerDiv.appendChild(headerDiv);

            // Avatar
            const avatarUrl = `https://api.dicebear.com/6.x/bottts/svg?seed=${encodeURIComponent(playerName)}`;
            const img = document.createElement('img');
            img.src = avatarUrl;
            img.width = 40;
            img.height = 40;
            headerDiv.appendChild(img);

            // Name
            const nameSpan = document.createElement('span');
            nameSpan.className = 'player-name';
            nameSpan.textContent = playerName;
            headerDiv.appendChild(nameSpan);

            // Next line: “hand” or “# of cards”
            const handDiv = document.createElement('div');
            handDiv.className = 'player-hand';

            if (playerName === localName) {
              // Show actual card info if it's the local player
              const playerHand = (hands && hands[playerName]) || [];
              handDiv.innerHTML = '<strong>Your Hand:</strong><br/>';
              // Show actual card info if it's the local player
              playerHand.forEach((card) => {
                // Create a container element for this card
                const cardElem = document.createElement('div');
                cardElem.className = 'card'; 
                // Some styling so the card is clickable
                cardElem.style.display = 'inline-block';
                cardElem.style.cursor = 'pointer';
                cardElem.style.margin = '4px';
                
                // If the deck has an imageUrl, use it:
                if (card.imageUrl) {
                  const img = document.createElement('img');
                  img.src = card.imageUrl;
                  img.width = 60; // or whatever size
                  cardElem.appendChild(img);
                } else {
                  // fallback text if no image
                  cardElem.textContent = card.id;
                  cardElem.style.background = '#e0e0e0';
                  cardElem.style.padding = '4px 8px';
                  cardElem.style.borderRadius = '4px';
                }

                // Add a click handler that asks: "Play this card?"
                cardElem.addEventListener('click', async () => {
                  const confirmPlay = confirm(`Play ${card.id}?`);
                  if (!confirmPlay) return;

                  // Now call the 'playMove' function
                  try {
                    const playMoveFn = firebase.functions().httpsCallable('playMove');
                    const move = {
                      actionType: 'PLAY_PROPERTY', // or 'PLAY_ACTION', etc.
                      card: card,
                      color: card.color,          // if property
                      playerId: localName,
                    };
                    const result = await playMoveFn({ gameId, move });
                    console.log('Move result:', result.data);
                  } catch (err) {
                    alert('Error playing property: ' + err.message);
                  }
                });

                handDiv.appendChild(cardElem);
              });
              } else {
                // For other players, just show "Cards in Hand: X"
                const playerHandCount = (hands && hands[playerName]) ? hands[playerName].length : 0;
                handDiv.textContent = `Cards in Hand: ${playerHandCount}`;
              }
            playerDiv.appendChild(handDiv);

            // Properties row
            const propDiv = document.createElement('div');
            propDiv.className = 'player-properties';
            propDiv.innerHTML = '<strong>Properties:</strong><br/>';
            const playerProps = (properties && properties[playerName]) || {};

            // Example: iterate each color => show each card
            Object.keys(playerProps).forEach((color) => {
              const cards = playerProps[color] || [];
              cards.forEach((card) => {
                const cardSpan = document.createElement('span');
                cardSpan.className = 'card';
                cardSpan.textContent = `${card.id} (${color})`;
                propDiv.appendChild(cardSpan);
              });
            });
            playerDiv.appendChild(propDiv);

            playersContainer.appendChild(playerDiv);
          });
        }

        // 4) Create Game
        document.getElementById('btnCreateGame').addEventListener('click', async () => {
          const playerName = document.getElementById('playerName').value.trim();
          if (!playerName) {
            alert('Please enter your name first!');
            return;
          }
          try {
            const createGameFn = functions.httpsCallable('createGame');
            const result = await createGameFn({
              hostUid: playerName,
              // We start in a 'lobby' status. The function can set it.
              // We'll pass initial playerIds as [playerName].
              playerIds: [playerName],
            });
            const gameId = result.data.gameId;
            alert('Created new game with ID: ' + gameId);
            watchGame(gameId);
          } catch (err) {
            console.error('Create game error:', err);
            alert(err.message);
          }
        });

        // 5) Join Game
        document.getElementById('btnJoinGame').addEventListener('click', async () => {
          const playerName = document.getElementById('playerName').value.trim();
          if (!playerName) {
            alert('Please enter your name first!');
            return;
          }
          const gameId = prompt('Enter game ID:');
          if (!gameId) return;

          const gameRef = db.collection('games').doc(gameId);
          try {
            // Add user’s name to the game’s playerIds array
            await db.runTransaction(async (transaction) => {
              const docSnap = await transaction.get(gameRef);
              if (!docSnap.exists) {
                throw new Error('Game does not exist!');
              }
              const data = docSnap.data();
              // If game has not started, let them join
              if (data.status === 'inProgress' || data.status === 'finished') {
                throw new Error('Game already in progress or finished!');
              }
              transaction.update(gameRef, {
                playerIds: firebase.firestore.FieldValue.arrayUnion(playerName),
              });
            });
            alert(`Joined game ${gameId} as ${playerName}`);
            watchGame(gameId);
          } catch (err) {
            console.error(err);
            alert(err.message);
          }
        });

        // 6) Play Property
        document.getElementById('btnPlayProperty').addEventListener('click', async () => {
          if (!currentGameId) {
            alert('No game joined yet.');
            return;
          }
          const playerName = document.getElementById('playerName').value.trim() || 'PLAYER_A';
          const playMoveFn = functions.httpsCallable('playMove');
          const move = {
            actionType: 'PLAY_PROPERTY',
            card: { id: 'p-red-1', type: 'property', color: 'red' },
            color: 'red',
            playerId: playerName,
          };
          try {
            const result = await playMoveFn({ gameId: currentGameId, move });
            console.log('Move result:', result.data);
          } catch (err) {
            alert('Error playing property: ' + err.message);
          }
        });

          // 7) Start Game (host only)
          document.getElementById('btnStartGame').addEventListener('click', async () => {
            if (!currentGameId) {
              alert('No game code available.');
              return;
            }
            try {
              const startGameFn = firebase.functions().httpsCallable('startGame');
              await startGameFn({ gameId: currentGameId });
              alert('Game started! (5 cards dealt to each player)');
            } catch (err) {
              console.error(err);
              alert(err.message);
            }
          });


      });
    </script>
  </body>
</html>